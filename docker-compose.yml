version: '3.9'

services:
  telegram-bot-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: telegram-bot-api
    restart: unless-stopped
    
    # 环境变量
    environment:
      - TELEGRAM_API_ID=${TELEGRAM_API_ID}
      - TELEGRAM_API_HASH=${TELEGRAM_API_HASH}
      - TELEGRAM_LOCAL=true
      - TELEGRAM_STAT=true
      - TELEGRAM_VERBOSITY=3
      - TELEGRAM_HTTP_IDLE_TIMEOUT=500
    
    # 端口映射
    ports:
      - "8081:8081"  # API端口
      - "8082:8082"  # 统计端口
    
    # 持久化存储
    volumes:
      - telegram-bot-api-data:/var/lib/telegram-bot-api
    
    # 启动命令
    command: >
      telegram-bot-api
      --api-id=${TELEGRAM_API_ID}
      --api-hash=${TELEGRAM_API_HASH}
      --http-port=8081
      --local
      --verbosity=3
    
    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # 资源限制（可选）
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

volumes:
  telegram-bot-api-data:
    driver: local

# 使用方法：
# 1. 创建 .env 文件并设置环境变量：
#    TELEGRAM_API_ID=your_api_id
#    TELEGRAM_API_HASH=your_api_hash
#
# 2. 启动服务：
#    docker-compose up -d
#
# 3. 查看日志：
#    docker-compose logs -f
#
# 4. 停止服务：
#    docker-compose down
#
# 5. 测试API：
#    curl http://localhost:8081/bot<YOUR_TOKEN>/getMe
